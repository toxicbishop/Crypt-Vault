name: Build and Test Crypt Vault

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # GCC comes pre-installed on Windows runner via MSYS2
      - name: Compile Crypt Vault (C++17)
        run: |
          mkdir build
          g++ -o build/Crypt-Vault.exe Crypt-Vault.cpp -std=c++17 -Wall -Wextra -O2 -ladvapi32

      - name: Run E2E Encryption/Decryption Test
        shell: powershell
        run: |
          # Create a dummy test file
          Set-Content -Path test.txt -Value "Secure Message 123"

          # Simulate user interactions via Standard Input:
          # 1) Encrypt test.txt to test.enc with password 'mypassword'
          # 2) Decrypt test.enc to decrypted.txt with password 'mypassword'
          # 11) Exit
          $inputs = "1", "test.txt", "test.enc", "mypassword", "", "2", "test.enc", "decrypted.txt", "mypassword", "", "11"

          # Pipe the inputs directly into our newly built executable
          $inputs | .\build\Crypt-Vault.exe

          Write-Host "`n--- Directory Listing (Debugging) ---"
          dir
          Write-Host "---------------------------------------"

          # Verify that the decrypted text exactly matches the original text
          $mismatch = Compare-Object (Get-Content test.txt) (Get-Content decrypted.txt)
          if ($mismatch) {
              Write-Error "Test failed: Decrypted file does not match original."
              exit 1
          } else {
              Write-Host "Test passed! Files matched."
          }
